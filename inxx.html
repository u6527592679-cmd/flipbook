<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Katalog produktów — wysoka jakość</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f6f8;margin:0;color:#111}
  header{text-align:center;padding:14px} h1{margin:0;font-size:20px}
  #wrap{max-width:1300px;margin:10px auto;padding:0 12px}
  /* kontener domyślnie A4-like ale skaluje się do szerokości ekranu */
  #flipbook{margin:12px auto;width:min(95vw,1100px);aspect-ratio:210/297;background:#fff;border:1px solid #e6e9ee;position:relative;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  .loader{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.96);padding:10px 14px;border-radius:8px;z-index:1500;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-weight:600}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
  button{padding:8px 12px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer}
  button.secondary{background:#6b7280}
  .page-info{margin-left:8px;color:#333}
</style>

<!-- PDF.js -->
<script src="pdfjs/pdf.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';</script>
<!-- StPageFlip -->
<script src="StPageFlip-2.0.0/page-flip.browser.min.js"></script>
</head>
<body>
<header><h1>Katalog produktów (wysoka jakość)</h1></header>
<div id="wrap">
  <div id="flipbook" aria-live="polite"></div>

  <div class="controls">
    <button id="prevBtn" class="secondary" disabled>◀ Poprzednia</button>
    <button id="nextBtn" disabled>Następna ▶</button>
    <button id="fullBtn" disabled>Pełny ekran</button>
    <span class="page-info" id="pageInfo">Ładowanie…</span>
    <a href="twoj_plik.pdf" download style="margin-left:8px;color:#1976d2;font-weight:600">Pobierz PDF</a>
  </div>
</div>

<script>
/* ========== USTAWIENIA ========== */
const PDF_URL = 'twoj_plik.pdf';
const DPR = Math.max(1, window.devicePixelRatio || 1);

/* DOC_DPI: docelowa rozdzielczość (dpi) w której chcemy renderować strony.
   Wyższe = ostrzejsze obrazy, ale większe zużycie pamięci.
   Zalecane: 150-300. Domyślnie ustawiam 200.
*/
const TARGET_DPI = 200;

/* bezpieczeństwo: maksymalny wymiar canvasa (piksele). Jeśli przekroczony, scale zostanie zredukowany.
   wartość 10000 to rozsądny kompromis; jeśli masz mocne urządzenia możesz podnieść.
*/
const MAX_CANVAS_DIM = 10000;
/* ================================ */

const container = document.getElementById('flipbook');
const loader = document.createElement('div'); loader.className = 'loader'; loader.innerText = 'Przygotowywanie...'; container.appendChild(loader);

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const fullBtn = document.getElementById('fullBtn');
const pageInfo = document.getElementById('pageInfo');

let pdfDoc = null, flipbook = null;
let pagesData = [];      // tablica dataURL dla flipbooka
let pagesCache = {};     // cache dla każdej strony

/* helper: tiny placeholder (white) */
function makePlaceholder() {
  const c = document.createElement('canvas'); c.width = 4; c.height = 4;
  const ctx = c.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0,0,4,4);
  return c.toDataURL();
}

/* oblicz fit scale dla danej strony (cover/contain) - przy scale=1 viewport.width = points* (1) */
async function computeFitScale(pageNumber, mode='cover') {
  const page = await pdfDoc.getPage(pageNumber);
  const vp = page.getViewport({ scale: 1 }); // bazowa jednostka
  const targetW = container.clientWidth * DPR;
  const targetH = container.clientHeight * DPR;
  const sx = targetW / vp.width;
  const sy = targetH / vp.height;
  return (mode === 'cover') ? Math.max(sx, sy) : Math.min(sx, sy);
}

/* oblicz scale docelowy bazując na TARGET_DPI i DPR, plus min-fit: */
async function computeScaleForHighQuality(pageNumber) {
  const fitScale = await computeFitScale(pageNumber, 'cover');          // dopasowanie
  const targetScale = (TARGET_DPI / 72) * DPR;                         // 72 DPI to baza PDF.js
  let scale = Math.max(fitScale, targetScale);
  // bezpieczeństwo: zmniejsz scale jeśli canvas byłby zbyt duży
  const page = await pdfDoc.getPage(pageNumber);
  const vp1 = page.getViewport({ scale: 1 });
  const predictedW = Math.round(vp1.width * scale);
  const predictedH = Math.round(vp1.height * scale);
  const maxDim = MAX_CANVAS_DIM;
  if (predictedW > maxDim || predictedH > maxDim) {
    const reduceFactor = Math.min(maxDim / predictedW, maxDim / predictedH);
    scale = scale * reduceFactor;
    console.warn(`Zredukowano scale dla strony ${pageNumber} aby uniknąć zbyt dużego canvas: nowy scale=${scale.toFixed(2)}`);
  }
  return scale;
}

/* render strony na canvas i zwróć dataURL (jpeg) */
async function renderPageToDataUrl(pageNumber, scale) {
  const page = await pdfDoc.getPage(pageNumber);
  const viewport = page.getViewport({ scale: scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  canvas.width = Math.round(viewport.width);
  canvas.height = Math.round(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  // jpeg 0.92 - dobry kompromis między wagą a jakością
  return canvas.toDataURL('image/jpeg', 0.92);
}

/* bezpieczne zaaplikowanie tablicy obrazów do flipbooka */
function applyImagesToFlipbook(images) {
  try {
    if (!flipbook) return;
    if (typeof flipbook.updateFromImages === 'function') {
      flipbook.updateFromImages(images);
      return;
    }
    if (typeof flipbook.loadFromImages === 'function') {
      flipbook.loadFromImages(images);
      return;
    }
    // fallback: podmień <img> w DOM jeśli są
    const imgs = container.querySelectorAll('img');
    for (let i=0;i<images.length && i<imgs.length;i++) imgs[i].src = images[i];
  } catch(e) { console.error('applyImages error', e); }
}

/* render i cache strony (jeśli nie ma) i aktualizuj flipbook */
async function ensurePageRendered(pageIndexZeroBased) {
  if (pagesCache[pageIndexZeroBased]) {
    pagesData[pageIndexZeroBased] = pagesCache[pageIndexZeroBased];
    applyImagesToFlipbook(pagesData);
    return;
  }
  const pageNum = pageIndexZeroBased + 1;
  const scale = await computeScaleForHighQuality(pageNum);
  const dataUrl = await renderPageToDataUrl(pageNum, scale);
  pagesCache[pageIndexZeroBased] = dataUrl;
  pagesData[pageIndexZeroBased] = dataUrl;
  applyImagesToFlipbook(pagesData);
}

/* nawigacja z fallbackami */
function nextPage() {
  if (!flipbook) return;
  if (typeof flipbook.flipNext === 'function') { try { flipbook.flipNext(); return; } catch(e) {} }
  if (typeof flipbook.turnToNextPage === 'function') flipbook.turnToNextPage();
}
function prevPage() {
  if (!flipbook) return;
  if (typeof flipbook.flipPrev === 'function') { try { flipbook.flipPrev(); return; } catch(e) {} }
  if (typeof flipbook.turnToPrevPage === 'function') flipbook.turnToPrevPage();
}

/* fullscreen */
function toggleFull() {
  if (!document.fullscreenElement) container.requestFullscreen?.() || container.webkitRequestFullscreen?.();
  else document.exitFullscreen?.();
}

/* ======= Init ======= */
async function init() {
  try {
    const loadingTask = pdfjsLib.getDocument(PDF_URL);
    pdfDoc = await loadingTask.promise;
    const numPages = pdfDoc.numPages;
    pageInfo.innerText = `Strona 0 / ${numPages}`;
    loader.innerText = `Przygotowywanie dokumentu (${numPages} stron)…`;

    // placeholdery
    const placeholder = makePlaceholder();
    pagesData = new Array(numPages).fill(placeholder);

    // init flipbook
    flipbook = new St.PageFlip(container, {
      width: 900, height: 1100, size: 'stretch', autoSize: true,
      minWidth: 300, maxWidth: 2000, minHeight: 300, maxHeight: 3000,
      showCover: false, usePortrait: true, maxShadowOpacity: 0.6, mobileScrollSupport: true
    });
    flipbook.loadFromImages(pagesData);

    // odblokuj kontrolki
    prevBtn.disabled = false; nextBtn.disabled = false; fullBtn.disabled = false;
    prevBtn.onclick = prevPage; nextBtn.onclick = nextPage; fullBtn.onclick = toggleFull;
    document.addEventListener('keydown', (e)=>{ if (e.key==='ArrowRight') nextPage(); if (e.key==='ArrowLeft') prevPage(); });

    if (typeof flipbook.on === 'function') {
      flipbook.on('flip', (e)=> {
        const idx = e.data;
        pageInfo.innerText = `Strona ${idx+1} / ${numPages}`;
        // ensure current page rendered in high quality (if not yet)
        ensurePageRendered(idx).catch(err=>console.error(err));
      });
    }

    // RENDER: renderujemy WSZYSTKIE strony w wysokiej jakości sekwencyjnie
    // (jeśli chcesz: możemy zamiast tego renderować tylko widoczne + lazy render reszty)
    for (let i=1;i<=numPages;i++){
      loader.style.display='block';
      loader.innerText = `Renderowanie (wysoka jakość) strony ${i} z ${numPages}...`;
      await ensurePageRendered(i-1);
    }
    loader.style.display='none';

    // final: ustaw stronę startową informację
    const cur = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
    pageInfo.innerText = `Strona ${cur+1} / ${numPages}`;

    console.log(`Render zakończony. TARGET_DPI=${TARGET_DPI}, DPR=${DPR}. Jeśli chcesz jeszcze wyższą jakość zmień TARGET_DPI (np. 300) lub rozważ konwersję PDF->PNG po stronie serwera.`);
  } catch (err) {
    console.error('Błąd inicjalizacji/w renderowaniu:', err);
    loader.innerText = 'Błąd ładowania dokumentu — sprawdź konsolę';
  }
}

window.addEventListener('load', init);
</script>
</body>
</html>
