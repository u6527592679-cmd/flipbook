<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Katalog produkt√≥w </title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f5f6f8;color:#111}
  header{padding:12px 14px;text-align:center;background:#fff;border-bottom:1px solid #eceff1}
  h1{margin:0;font-size:20px}
  #wrap{max-width:1400px;margin:8px auto;padding:10px}
  #flipbook{margin:10px auto;width:calc(100% - 40px);max-width:1300px;background:#fff;border:1px solid #e6e9ee;position:relative;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;margin:8px 0}
  button{padding:8px 12px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer}
  button.secondary{background:#6b7280}
  button:disabled{opacity:.55;cursor:not-allowed}
  .page-info{margin-left:8px;color:#333}
  @media (max-width:700px){ #flipbook{width:calc(100% - 24px);} }
  #flipbook img {width:100%;height:auto;max-width:100%;object-fit:contain;display:block;margin:0 auto;}
  /* Modal zoom */
  .zoom-modal {
    display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;
    background:rgba(0,0,0,0.89);justify-content:center;align-items:center;
    overflow:hidden;
  }
  .zoom-modal.active {display:flex;}
  .zoom-modal .close {
    position:absolute;top:24px;right:40px;font-size:38px;color:#fff;font-weight:900;cursor:pointer;z-index:10;
    background:rgba(0,0,0,0.22);border-radius:10px;width:46px;height:46px;display:flex;align-items:center;justify-content:center;
    transition:background 0.2s;
  }
  .zoom-modal .close:hover {background:rgba(0,0,0,0.5);}
  .zoom-img-wrap {
    position:relative;display:flex;align-items:center;justify-content:center;flex:1 1 0%;
    width:100vw;height:100vh;overflow:hidden;
    touch-action:none;
  }
  .zoom-img-wrap img {
    max-width:95vw; max-height:95vh; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,0.25);
    background:#fff; display:block;
    cursor:grab;
    user-select:none;
    transition:box-shadow 0.2s;
    will-change: transform;
    position:relative;
  }
  .zoom-img-wrap img:active { cursor:grabbing; }
  .zoom-hint {
    position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.55);color:#fff;padding:5px 16px;border-radius:8px;font-size:15px;
    z-index:20;pointer-events:none;
  }
</style>
<!-- StPageFlip -->
<script src="StPageFlip-2.0.0/page-flip.browser.min.js"></script>
</head>
<body>
<header><h1>Katalog produkt√≥w</h1></header>

<div id="wrap">
  <div id="flipbook" aria-live="polite"></div>

  <div class="controls" role="toolbar" aria-label="Kontrolki flipbook">
    <button id="prevBtn" class="secondary" disabled>‚óÄ Poprzednia</button>
    <button id="nextBtn" disabled>Nastƒôpna ‚ñ∂</button>
    <button id="fullBtn" disabled>Pe≈Çny ekran</button>
    <button id="zoomLeftBtn" disabled title="Zbli≈º lewƒÖ stronƒô">üîç Zbli≈º lewƒÖ</button>
    <button id="zoomRightBtn" disabled title="Zbli≈º prawƒÖ stronƒô">üîç Zbli≈º prawƒÖ</button>
    <span class="page-info" id="pageInfo">≈Åadowanie‚Ä¶</span>
  </div>
</div>

<!-- Modal do zbli≈ºenia -->
<div class="zoom-modal" id="zoomModal">
  <span class="close" id="zoomClose">&times;</span>
  <div class="zoom-img-wrap" id="zoomImgWrap">
    <img id="zoomImg" src="" alt="Zbli≈ºona strona">
    <div class="zoom-hint" id="zoomHint">Przytrzymaj i przeciƒÖgnij, aby przesuwaƒá. U≈ºyj scrolla, aby powiƒôkszaƒá.</div>
  </div>
</div>

<script>
const NUM_PAGES = 19;
const FILE_BASE = '/pages/twoj_plik1-';
const FILE_EXT = '.png';

function getPagesArray() {
  const arr = [];
  for(let i=1;i<=NUM_PAGES;i++) {
    const num = i.toString().padStart(2,'0');
    arr.push(FILE_BASE + num + FILE_EXT);
  }
  return arr;
}

const container = document.getElementById('flipbook');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const fullBtn = document.getElementById('fullBtn');
const zoomLeftBtn = document.getElementById('zoomLeftBtn');
const zoomRightBtn = document.getElementById('zoomRightBtn');
const pageInfo = document.getElementById('pageInfo');
const zoomModal = document.getElementById('zoomModal');
const zoomImgWrap = document.getElementById('zoomImgWrap');
const zoomImg = document.getElementById('zoomImg');
const zoomClose = document.getElementById('zoomClose');
const zoomHint = document.getElementById('zoomHint');

let flipbook = null;

// snapshot of inline styles before entering fullscreen (so we can fully restore them)
let originalInlineStyles = {
  position: '',
  top: '',
  left: '',
  width: '',
  height: '',
  zIndex: ''
};
let isManualFullscreen = false;

function saveOriginalInlineStyles() {
  // store the current inline styles (may be empty strings if not set)
  originalInlineStyles.position = container.style.position || '';
  originalInlineStyles.top = container.style.top || '';
  originalInlineStyles.left = container.style.left || '';
  originalInlineStyles.width = container.style.width || '';
  originalInlineStyles.height = container.style.height || '';
  originalInlineStyles.zIndex = container.style.zIndex || '';
}

function restoreOriginalInlineStyles() {
  container.style.position = originalInlineStyles.position;
  container.style.top = originalInlineStyles.top;
  container.style.left = originalInlineStyles.left;
  container.style.width = originalInlineStyles.width;
  container.style.height = originalInlineStyles.height;
  container.style.zIndex = originalInlineStyles.zIndex;
  isManualFullscreen = false;
}

function applyManualFullscreenStyles() {
  // apply fallback fullscreen by setting inline styles
  container.style.position = 'fixed';
  container.style.top = '0';
  container.style.left = '0';
  container.style.width = '100vw';
  container.style.height = '100vh';
  container.style.zIndex = '9999';
  isManualFullscreen = true;
}

function setContainerHeight(){
  const headerH = document.querySelector('header').offsetHeight || 0;
  const controlsH = document.querySelector('.controls').offsetHeight || 0;
  const margin = 18;
  const available = Math.max(200, window.innerHeight - headerH - controlsH - margin);
  container.style.height = available + 'px';
}

// navigation helpers
function nextPage(){ if(flipbook){ if(typeof flipbook.flipNext==='function'){ try{ flipbook.flipNext(); return;}catch(e){} } if(typeof flipbook.turnToNextPage==='function') flipbook.turnToNextPage(); }}
function prevPage(){ if(flipbook){ if(typeof flipbook.flipPrev==='function'){ try{ flipbook.flipPrev(); return;}catch(e){} } if(typeof flipbook.turnToPrevPage==='function') flipbook.turnToPrevPage(); }}

// toggle fullscreen (uses native Fullscreen API when available; falls back to manual)
function toggleFull() {
  const inFs = !!(document.fullscreenElement || document.webkitFullscreenElement);
  if (!inFs) {
    // save inline styles BEFORE trying to enter fullscreen
    saveOriginalInlineStyles();

    if (container.requestFullscreen) {
      container.requestFullscreen({ navigationUI: 'hide' }).catch(()=>{});
    } else if (container.webkitRequestFullscreen) {
      container.webkitRequestFullscreen({ navigationUI: 'hide' });
    } else {
      // fallback for browsers without Fullscreen API
      applyManualFullscreenStyles();
    }
  } else {
    // exit fullscreen (native or webkit)
    if (document.exitFullscreen) {
      document.exitFullscreen().catch(()=>{});
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else {
      // if no native API, restore previously saved styles
      restoreOriginalInlineStyles();
      // ensure layout recalculation and flipbook update
      setTimeout(()=>{
        setContainerHeight();
        if(flipbook && typeof flipbook.update === 'function') flipbook.update();
      }, 60);
    }
  }
}

function debounce(fn,wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

function updatePageInfo() {
  if(!flipbook) return;
  let cur = 0, total = NUM_PAGES;
  if(typeof flipbook.getCurrentPageIndex==='function') {
    cur = flipbook.getCurrentPageIndex();
  } else if(typeof flipbook.getCurrentPageIndex==='number') {
    cur = flipbook.getCurrentPageIndex;
  }
  pageInfo.innerText = `Strona ${cur+1} / ${total}`;
}

function showZoomModal(pageIndex) {
  // pageIndex 0-based
  const pages = getPagesArray();
  if(pageIndex < 0 || pageIndex >= pages.length) return;
  zoomImg.src = pages[pageIndex];
  zoomModal.classList.add('active');
  document.body.style.overflow = 'hidden';
  setTimeout(() => setupImgZoom(), 100);
}
function hideZoomModal() {
  zoomModal.classList.remove('active');
  zoomImg.src = '';
  document.body.style.overflow = '';
  removeImgZoom();
}

// --- Zoom na obrazku w modalu ---
let zoom = 1, minZoom = 1, maxZoom = 6, originX = 0, originY = 0, panX = 0, panY = 0, isPanning = false, startX = 0, startY = 0;
function setupImgZoom() {
  zoom = 1; panX = 0; panY = 0; originX = 0; originY = 0;
  applyImgTransform();
  zoomImg.style.cursor = 'grab';

  zoomImg.onwheel = function(e) {
    e.preventDefault();
    let rect = zoomImg.getBoundingClientRect();
    let mouseX = e.clientX - rect.left;
    let mouseY = e.clientY - rect.top;

    // Ustal punkt zoomowania (proporcje)
    let relX = (mouseX - panX) / zoom;
    let relY = (mouseY - panY) / zoom;

    let delta = e.deltaY < 0 ? 1.15 : 0.87;
    let newZoom = Math.max(minZoom, Math.min(maxZoom, zoom * delta));
    // korekta przesuniƒôcia ≈ºeby zoomowaƒá wzglƒôdem kursora
    panX -= (relX * (newZoom - zoom));
    panY -= (relY * (newZoom - zoom));
    zoom = newZoom;
    applyImgTransform();
  };

  zoomImg.onmousedown = function(e) {
    if(zoom === 1) return;
    isPanning = true;
    startX = e.clientX - panX;
    startY = e.clientY - panY;
    zoomImg.style.cursor = 'grabbing';
    document.onmousemove = function(e) {
      if(!isPanning) return;
      panX = e.clientX - startX;
      panY = e.clientY - startY;
      applyImgTransform();
    };
    document.onmouseup = function() {
      isPanning = false;
      zoomImg.style.cursor = 'grab';
      document.onmousemove = null;
      document.onmouseup = null;
    };
  };
  zoomImg.ondblclick = function(e){
    if(zoom===1) {
      // powiƒôksz do 2x wok√≥≈Ç kursora
      let rect = zoomImg.getBoundingClientRect();
      let mouseX = e.clientX - rect.left;
      let mouseY = e.clientY - rect.top;
      let relX = (mouseX - panX) / zoom;
      let relY = (mouseY - panY) / zoom;
      let newZoom = 2;
      panX -= (relX * (newZoom - zoom));
      panY -= (relY * (newZoom - zoom));
      zoom = newZoom;
    } else {
      zoom = 1; panX = 0; panY = 0;
    }
    applyImgTransform();
  };
  zoomImg.onmousemove = function(e) { if(zoom>1){zoomImg.style.cursor='grabbing';}else{zoomImg.style.cursor='grab';}};
  zoomImg.onmouseleave = function(e){ if(isPanning) {isPanning=false; zoomImg.style.cursor='grab'; document.onmousemove=null; document.onmouseup=null;}};
  // Ukryj podpowied≈∫ po chwili
  zoomHint.style.opacity = 1;
  setTimeout(()=>{zoomHint.style.opacity=0;}, 5000);
}
function removeImgZoom() {
  zoomImg.onwheel = null;
  zoomImg.onmousedown = null;
  zoomImg.ondblclick = null;
  zoomImg.onmousemove = null;
  zoomImg.onmouseleave = null;
  zoomHint.style.opacity = 0;
}
function applyImgTransform() {
  zoomImg.style.transform = `translate(${panX}px,${panY}px) scale(${zoom})`;
}

async function init(){
  // compute initial height and save inline styles snapshot
  setContainerHeight();

  // save a snapshot of inline styles now (after initial height calc)
  saveOriginalInlineStyles();

  const pages = getPagesArray();

  flipbook = new St.PageFlip(container, {
    width:900, height:1200,
    size:'stretch', autoSize:true,
    minWidth:300, maxWidth:2000, minHeight:300, maxHeight:3000,
    showCover:false, usePortrait:true, maxShadowOpacity:0.6, mobileScrollSupport:true
  });
  flipbook.loadFromImages(pages);

  prevBtn.disabled=false; nextBtn.disabled=false; fullBtn.disabled=false; zoomLeftBtn.disabled=false; zoomRightBtn.disabled=false;
  prevBtn.onclick = prevPage; nextBtn.onclick = nextPage; fullBtn.onclick = toggleFull;

  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') nextPage();
    if(e.key==='ArrowLeft') prevPage();
    if(zoomModal.classList.contains('active') && e.key==='Escape') hideZoomModal();
  });

  // Zbli≈º lewƒÖ stronƒô
  zoomLeftBtn.onclick = () => {
    if(!flipbook) return;
    let idx = 0;
    if(typeof flipbook.getCurrentPageIndex==='function') {
      idx = flipbook.getCurrentPageIndex();
    } else if(typeof flipbook.getCurrentPageIndex==='number') {
      idx = flipbook.getCurrentPageIndex;
    }
    showZoomModal(idx);
  };

  // Zbli≈º prawƒÖ stronƒô
  zoomRightBtn.onclick = () => {
    if(!flipbook) return;
    let idx = 0;
    if(typeof flipbook.getCurrentPageIndex==='function') {
      idx = flipbook.getCurrentPageIndex();
    } else if(typeof flipbook.getCurrentPageIndex==='number') {
      idx = flipbook.getCurrentPageIndex;
    }
    showZoomModal(idx+1);
  };

  zoomClose.onclick = hideZoomModal;
  zoomModal.onclick = (e) => {
    if(e.target === zoomModal) hideZoomModal();
  };
  zoomImg.onclick = (e) => { if(zoom===1) hideZoomModal(); };

  flipbook.on('flip', updatePageInfo);
  flipbook.on('init', updatePageInfo);
  setTimeout(updatePageInfo, 500);

  const onResize = debounce(()=>{
    // recalc height and tell flipbook to update
    setContainerHeight();
    if(typeof flipbook.update === 'function') flipbook.update();
    // also refresh snapshot of inline height (user resized window while not in fullscreen)
    if(!document.fullscreenElement && !document.webkitFullscreenElement && !isManualFullscreen) {
      // update stored original height to reflect new layout
      originalInlineStyles.height = container.style.height || '';
      originalInlineStyles.width = container.style.width || '';
    }
  },220);
  window.addEventListener('resize',onResize);

  // handle exit from native fullscreen
  function handleFullscreenChange() {
    // if there is no fullscreen element, we have EXITED fullscreen
    if(!document.fullscreenElement && !document.webkitFullscreenElement) {
      // if we used manual fallback earlier, restore from snapshot; otherwise also restore (safe)
      setTimeout(()=>{
        restoreOriginalInlineStyles();
        setContainerHeight();
        if(flipbook && typeof flipbook.update === 'function') flipbook.update();
      }, 120);
    } else {
      // ENTERED fullscreen (native) - nothing else required because the browser handles sizing
      // but we keep our snapshot (saved earlier) to restore later
    }
  }
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
}

window.addEventListener('load',init);
</script>
</body>
</html>
