<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Katalog produktów — szybkie renderowanie</title>
  <style>
    /* Stylizacja strony i flipbooka */
    body {
      font-family: Arial,Helvetica,sans-serif;
      margin: 0;
      background: #f5f6f8;
      color: #111;
    }
    header {
      padding: 12px 14px;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid #eceff1;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    #wrap {
      max-width: 1400px;
      margin: 8px auto;
      padding: 10px;
    }
    #flipbook {
      margin: 10px auto;
      width: calc(100% - 40px);
      max-width: 1300px;
      background: #fff;
      border: 1px solid #e6e9ee;
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }
    .loader {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      background: rgba(255,255,255,0.95);
      padding: 10px 14px;
      border-radius: 8px;
      z-index: 1500;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-weight: 600;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      margin: 8px 0;
    }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
    }
    button.secondary {
      background: #6b7280;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .page-info {
      margin-left: 8px;
      color: #333;
    }
    @media (max-width:700px) {
      #flipbook { width: calc(100% - 24px); }
    }
  </style>

  <!-- Dołączenie PDF.js -->
  <script src="pdfjs/pdf.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';</script>
  <!-- Dołączenie StPageFlip -->
  <script src="StPageFlip-2.0.0/page-flip.browser.min.js"></script>
</head>
<body>
  <header><h1>Katalog produktów — flipbook</h1></header>

  <div id="wrap">
    <div id="flipbook" aria-live="polite"></div>

    <!-- Kontrolki do nawigacji -->
    <div class="controls" role="toolbar" aria-label="Kontrolki flipbook">
      <button id="prevBtn" class="secondary" disabled>◀ Poprzednia</button>
      <button id="nextBtn" disabled>Następna ▶</button>
      <button id="fullBtn" disabled>Pełny ekran</button>
      <span class="page-info" id="pageInfo">Ładowanie…</span>
      <a href="twoj_plik.pdf" download style="margin-left:12px;color:#1976d2;font-weight:600">Pobierz PDF</a>
    </div>
  </div>

<script>
// ======= USTAWIENIA =======
const PDF_URL = 'twoj_plik.pdf';  // Ścieżka do Twojego pliku PDF
const DPR = Math.max(1, window.devicePixelRatio || 1);
// Maksymalny rozmiar canvas, aby nie utworzyć zbyt dużego elementu
const MAX_CANVAS_DIM = 14000;
// ==========================

pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';

const container = document.getElementById('flipbook');
const loader = document.createElement('div');
loader.className = 'loader';
loader.innerText = 'Przygotowywanie...';
container.appendChild(loader);

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const fullBtn = document.getElementById('fullBtn');
const pageInfo = document.getElementById('pageInfo');

let pdfDoc = null;
let flipbook = null;
let pagesData = [];        // Tablica z obrazami stron (data URL)
let pagesCache = {};       // Cache: index strony -> data URL

// Tworzy bardzo mały biały placeholder (pozwala szybko zainicjować flipbook)
function makePlaceholder(){
  const c = document.createElement('canvas');
  c.width = 4; c.height = 4;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,4,4);
  return c.toDataURL();
}

// Ustawia wysokość kontenera flipbooka tak, aby wypełniał dostępną przestrzeń (minus nagłówek i kontrolki)
function setContainerHeight(){
  const headerH = document.querySelector('header').offsetHeight || 0;
  const controlsH = document.querySelector('.controls').offsetHeight || 0;
  const margin = 18;
  const available = Math.max(200, window.innerHeight - headerH - controlsH - margin);
  container.style.height = available + 'px';
}

// Oblicza skalę renderowania strony, tak aby wypełnić (lub zmieścić) obszar kontenera
async function computeFitScale(pageNumber, mode = 'cover'){
  const page = await pdfDoc.getPage(pageNumber);
  const vp = page.getViewport({ scale: 1 });
  const targetW = container.clientWidth * DPR;
  const targetH = container.clientHeight * DPR;
  const sx = targetW / vp.width;
  const sy = targetH / vp.height;
  return (mode === 'cover') ? Math.max(sx, sy) : Math.min(sx, sy);
}

// Renderuje pojedynczą stronę PDF na obraz w podanej skali
async function renderPageToDataUrl(pageNumber, scale) {
  const page = await pdfDoc.getPage(pageNumber);
  const base = page.getViewport({ scale: 1 });
  let predictedW = Math.round(base.width * scale);
  let predictedH = Math.round(base.height * scale);
  // Jeśli rozmiary byłyby zbyt duże, zmniejszamy skalę
  if (predictedW > MAX_CANVAS_DIM || predictedH > MAX_CANVAS_DIM) {
    const reduce = Math.min(MAX_CANVAS_DIM / predictedW, MAX_CANVAS_DIM / predictedH);
    scale = scale * reduce;
    predictedW = Math.round(base.width * scale);
    predictedH = Math.round(base.height * scale);
    console.warn('Skala zredukowana dla strony', pageNumber, 'nowa skala', scale.toFixed(2));
  }
  const viewport = page.getViewport({ scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  canvas.width = Math.round(viewport.width);
  canvas.height = Math.round(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  return canvas.toDataURL('image/jpeg', 0.9);
}

// Wstawia obrazy (data URL) do flipbooka
function applyImages(images) {
  if (!flipbook) return;
  // Jeśli biblioteka udostępnia metodę updateFromImages (StPageFlip v2+), używamy jej
  if (typeof flipbook.updateFromImages === 'function') {
    flipbook.updateFromImages(images);
    return;
  }
  // W starszej wersji może być loadFromImages
  if (typeof flipbook.loadFromImages === 'function') {
    flipbook.loadFromImages(images);
    return;
  }
  // Fallback: zmieniamy src <img> jeśli flipbook używa zwykłych <img>
  const imgs = container.querySelectorAll('img');
  for (let i=0; i<images.length && i<imgs.length; i++) {
    imgs[i].src = images[i];
  }
}

// Zapewnia, że dana strona jest wyrenderowana i dostępna w tablicy pagesData
async function ensurePage(indexZeroBased) {
  if (pagesCache[indexZeroBased]) {
    pagesData[indexZeroBased] = pagesCache[indexZeroBased];
    applyImages(pagesData);
    return;
  }
  const pageNum = indexZeroBased + 1;
  const scale = await computeFitScale(pageNum, 'cover');
  const dataUrl = await renderPageToDataUrl(pageNum, scale);
  pagesCache[indexZeroBased] = dataUrl;
  pagesData[indexZeroBased] = dataUrl;
  applyImages(pagesData);
}

// Przejście do następnej strony flipbooka
function nextPage(){
  if (!flipbook) return;
  if (typeof flipbook.flipNext === 'function') {
    try { flipbook.flipNext(); return; } catch(e){}
  }
  if (typeof flipbook.turnToNextPage === 'function') {
    flipbook.turnToNextPage();
  }
}
// Przejście do poprzedniej strony flipbooka
function prevPage(){
  if (!flipbook) return;
  if (typeof flipbook.flipPrev === 'function') {
    try { flipbook.flipPrev(); return; } catch(e){}
  }
  if (typeof flipbook.turnToPrevPage === 'function') {
    flipbook.turnToPrevPage();
  }
}

// Przełącza widok pełnoekranowy flipbooka
function toggleFull(){
  if (!document.fullscreenElement) {
    container.requestFullscreen?.() || container.webkitRequestFullscreen?.();
  } else {
    document.exitFullscreen?.();
  }
}

// Debounce – przydaje się przy zdarzeniu resize
function debounce(fn, wait) {
  let t;
  return (...a) => {
    clearTimeout(t);
    t = setTimeout(()=>fn(...a), wait);
  };
}

// ======== INICJALIZACJA ========
async function init(){
  try {
    // Ustawienie wysokości kontenera na podstawie okna przeglądarki
    setContainerHeight();
    // Załaduj dokument PDF
    const loadingTask = pdfjsLib.getDocument(PDF_URL);
    pdfDoc = await loadingTask.promise;
    const numPages = pdfDoc.numPages;
    pageInfo.innerText = `Strona 0 / ${numPages}`;
    loader.innerText = `Przygotowywanie dokumentu — ${numPages} stron`;

    // Przygotuj tablicę z placeholderami na obrazy stron
    const placeholder = makePlaceholder();
    pagesData = new Array(numPages).fill(placeholder);

    // Inicjalizacja flipbooka
    flipbook = new St.PageFlip(container, {
      width: 900, height: 1100,
      size: 'stretch', autoSize: true,
      minWidth: 300, maxWidth: 2000,
      minHeight: 300, maxHeight: 3000,
      showCover: false, usePortrait: true,
      maxShadowOpacity: 0.6, mobileScrollSupport: true
    });
    // Załaduj flipbook z placeholderami (puste białe strony)
    flipbook.loadFromImages(pagesData);

    // Włącz przyciski nawigacji
    prevBtn.disabled = false;
    nextBtn.disabled = false;
    fullBtn.disabled = false;
    prevBtn.onclick = prevPage;
    nextBtn.onclick = nextPage;
    fullBtn.onclick = toggleFull;
    // Obsługa klawiatury: strzałki lewo/prawo
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') nextPage();
      if (e.key === 'ArrowLeft') prevPage();
    });

    // Gdy flipbook wykona flip (zmianę strony)
    if (typeof flipbook.on === 'function') {
      flipbook.on('flip', async (e) => {
        const idx = e.data; // indeks aktualnie widocznej lewej strony (0-based)
        pageInfo.innerText = `Strona ${idx+1} / ${numPages}`;
        loader.style.display = 'block';
        loader.innerText = `Wczytywanie strony ${idx+1}...`;
        // Renderuj bieżącą stronę (by mieć aktualny obraz)
        await ensurePage(idx);
        // Wstępne ładowanie sąsiednich stron dla płynniejszej nawigacji
        if (idx - 1 >= 0 && !pagesCache[idx - 1]) {
          ensurePage(idx - 1).catch(()=>{});
        }
        if (idx + 1 < numPages && !pagesCache[idx + 1]) {
          ensurePage(idx + 1).catch(()=>{});
        }
        loader.style.display = 'none';
      });
    }

    // Na start wczytaj pierwsze dwie strony
    loader.innerText = 'Wczytywanie pierwszych stron...';
    await ensurePage(0);
    if (numPages >= 2) {
      await ensurePage(1);
    }
    loader.style.display = 'none';
    // Aktualizuj informację o stronach
    const cur = (typeof flipbook.getCurrentPageIndex === 'function') ?
      flipbook.getCurrentPageIndex() : 0;
    pageInfo.innerText = `Strona ${cur+1} / ${numPages}`;

    // Obsługa zmiany rozmiaru okna – skalowanie aktualnej strony
    const onResize = debounce(async () => {
      setContainerHeight();
      const curIdx = (typeof flipbook.getCurrentPageIndex === 'function') ?
        flipbook.getCurrentPageIndex() : 0;
      // Wyczyść cache bieżącej strony, aby zrenderować ją ponownie w nowej skali
      delete pagesCache[curIdx];
      loader.style.display = 'block';
      loader.innerText = 'Dopasowywanie do rozmiaru ekranu...';
      await ensurePage(curIdx);
      loader.style.display = 'none';
      try {
        if (typeof flipbook.turnToPage === 'function') {
          flipbook.turnToPage(curIdx);
        }
      } catch(e){}
    }, 220);

    window.addEventListener('resize', onResize);

  } catch(err) {
    console.error('Błąd inicjalizacji:', err);
    loader.innerText = 'Błąd ładowania dokumentu — sprawdź konsolę';
  }
}

// Rozpocznij inicjalizację po załadowaniu strony
window.addEventListener('load', init);
</script>
</body>
</html>
