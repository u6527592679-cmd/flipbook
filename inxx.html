<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" />
  <title>Katalog produktów</title>
  <style>
    :root{--accent:#1976d2;--accent-dark:#1565c0}
    body{font-family:Inter, Arial, Helvetica, sans-serif;margin:0;background:#f5f7fa;color:#111}
    header{padding:18px 12px;text-align:center}
    h1{margin:0;font-size:20px}
    #wrap{max-width:1200px;margin:18px auto;padding:0 12px}
    #flipbook{margin: 12px auto; width: 94%; max-width:1000px; height:72vh; min-height:360px; background:#fff; border:1px solid #e2e6ea; position:relative; box-shadow:0 8px 24px rgba(0,0,0,0.06); overflow:hidden}
    .loader{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-weight:600;z-index:1500}
    .controls{display:flex;gap:10px;justify-content:center;align-items:center;margin:12px 0;z-index:1200;position:relative}
    .controls button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 6px 16px rgba(25,118,210,0.12)}
    .controls button.secondary{background:#6b7280}
    .controls button:disabled{opacity:.55;cursor:not-allowed}
    .zoom-controls{display:inline-flex;gap:6px;margin-left:8px}
    .page-info{font-size:14px;color:#333;margin-left:8px}
    /* magnifier */
    .magnifier{position:fixed;width:220px;height:220px;border-radius:50%;overflow:hidden;border:3px solid rgba(0,0,0,0.12);box-shadow:0 10px 30px rgba(0,0,0,0.12);pointer-events:none;display:none;z-index:9999;background:#fff}
    @media(max-width:760px){
      #flipbook{height:72vh}
      .magnifier{width:140px;height:140px}
      .controls{flex-wrap:wrap}
    }
  </style>
  <!-- PDF.js -->
  <script src="pdfjs/pdf.js"></script>
  <!-- StPageFlip -->
  <script src="StPageFlip-2.0.0/page-flip.browser.min.js"></script>
</head>
<body>
  <header>
    <h1>Katalog produktów</h1>
  </header>

  <div id="wrap">
    <div id="flipbook" aria-live="polite"></div>

    <div class="controls" role="toolbar" aria-label="Kontrolki flipbooka">
      <button id="prevBtn" class="secondary" disabled>◀ Poprzednia</button>
      <button id="nextBtn" disabled>Następna ▶</button>

      <div class="zoom-controls" aria-hidden="false">
        <button id="zoomOutBtn" title="Pomniejsz" disabled>−</button>
        <button id="zoomResetBtn" title="Reset" disabled>Reset</button>
        <button id="zoomInBtn" title="Powiększ" disabled>+</button>
        <button id="toggleLoupeBtn" title="Lupa" disabled style="background:#388e3c">Lupa</button>
      </div>

      <span class="page-info" id="pageInfo">Ładowanie…</span>
      <a id="downloadPdf" href="twoj_plik.pdf" download style="margin-left:12px;color:var(--accent);font-weight:600;text-decoration:none">Pobierz PDF</a>
    </div>

    <div id="magnifier" class="magnifier" aria-hidden="true"></div>
  </div>

<script>
/* ================= KONFIGURACJA ================= */
const PDF_URL = "twoj_plik.pdf"; // dostosuj jeśli trzeba
const DPR = Math.max(1, window.devicePixelRatio || 1);
const DESKTOP_BASE_SCALE = 1.2;
const MOBILE_BASE_SCALE = 0.95;
let baseScale = (window.innerWidth <= 760) ? MOBILE_BASE_SCALE : DESKTOP_BASE_SCALE;
let currentScale = baseScale * DPR;
const LOUPE_SCALE_MULT = Math.max(2, DPR * 2);
/* ================================================ */

pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js'; // upewnij się, że ścieżka istnieje

const container = document.getElementById('flipbook');
const loader = document.createElement('div');
loader.className = 'loader';
loader.innerText = 'Przygotowywanie...';
container.appendChild(loader);

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const zoomInBtn = document.getElementById('zoomInBtn');
const zoomOutBtn = document.getElementById('zoomOutBtn');
const zoomResetBtn = document.getElementById('zoomResetBtn');
const toggleLoupeBtn = document.getElementById('toggleLoupeBtn');
const pageInfo = document.getElementById('pageInfo');
const magnifier = document.getElementById('magnifier');

let pdfDoc = null;
let flipbook = null;
let pagesDataUrls = []; // pełna tablica dataURL (0-based)
let pagesCache = {};    // pagesCache[index] = { high: dataUrl, zoom: dataUrl, loupe: dataUrl }

/* pomocnicze: placeholder tiny white image */
function createPlaceholderDataUrl(){
  const c = document.createElement('canvas');
  c.width = 4; c.height = 4;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,c.width,c.height);
  return c.toDataURL();
}

/* render strony na konkretnym scale -> dataURL (jpeg) */
async function renderPageToDataUrl(pageNumber, scale) {
  const page = await pdfDoc.getPage(pageNumber);
  const viewport = page.getViewport({ scale: scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  canvas.width = Math.round(viewport.width);
  canvas.height = Math.round(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  return canvas.toDataURL('image/jpeg', 0.92);
}

/* BEZPIECZNY update: najpierw spróbuj updateFromImages, jeśli nie ma -> loadFromImages, ostatecznie spróbuj podmiany DOM */
function applyPagesArrayToFlipbook(imagesArray){
  try{
    if (!flipbook) return;
    if (typeof flipbook.updateFromImages === 'function') {
      flipbook.updateFromImages(imagesArray);
      return;
    }
    if (typeof flipbook.loadFromImages === 'function') {
      flipbook.loadFromImages(imagesArray);
      return;
    }
    // Ostateczny DOM-fallback: spróbuj podmienić img elementy w kontenerze
    const imgs = container.querySelectorAll('img');
    for (let i = 0; i < imagesArray.length && i < imgs.length; i++){
      imgs[i].src = imagesArray[i];
    }
  }catch(e){
    console.error('applyPagesArrayToFlipbook error', e);
  }
}

/* replace single page: rendruj, zapisz w cache i zaktualizuj widok (bez updatePage) */
async function replacePage(pageIndexZeroBased, scale, qualityKey='high'){
  const pageNumber = pageIndexZeroBased + 1;
  pagesCache[pageIndexZeroBased] = pagesCache[pageIndexZeroBased] || {};

  if (pagesCache[pageIndexZeroBased][qualityKey]) {
    // mamy w cache - użyj bez renderowania
    pagesDataUrls[pageIndexZeroBased] = pagesCache[pageIndexZeroBased][qualityKey];
    applyPagesArrayToFlipbook(pagesDataUrls);
    return;
  }

  // render
  const dataUrl = await renderPageToDataUrl(pageNumber, scale);
  pagesCache[pageIndexZeroBased][qualityKey] = dataUrl;
  pagesDataUrls[pageIndexZeroBased] = dataUrl;

  // zaktualizuj flipbook
  applyPagesArrayToFlipbook(pagesDataUrls);
}

/* pomocnik: next/prev page z fallbackiem na nazwę metody */
function nextPage(){
  if (!flipbook) return;
  if (typeof flipbook.flipNext === 'function') { try { flipbook.flipNext(); return; } catch(e){} }
  if (typeof flipbook.turnToNextPage === 'function') { flipbook.turnToNextPage(); return; }
}
function prevPage(){
  if (!flipbook) return;
  if (typeof flipbook.flipPrev === 'function') { try { flipbook.flipPrev(); return; } catch(e){} }
  if (typeof flipbook.turnToPrevPage === 'function') { flipbook.turnToPrevPage(); return; }
}

/* ---------- INICJALIZACJA ---------- */
async function init(){
  try{
    const loadingTask = pdfjsLib.getDocument(PDF_URL);
    pdfDoc = await loadingTask.promise;
    const numPages = pdfDoc.numPages;
    pageInfo.innerText = `Strona 0 / ${numPages}`;

    // placeholdery
    const placeholder = createPlaceholderDataUrl();
    pagesDataUrls = new Array(numPages).fill(placeholder);

    // inicjalizuj flipbook od razu (by unikać "Invalid page number")
    flipbook = new St.PageFlip(container, {
      width: 900,
      height: 1100,
      size: "stretch",
      autoSize: true,
      minWidth: 300,
      maxWidth: 1600,
      minHeight: 300,
      maxHeight: 2000,
      showCover: false,
      usePortrait: true,
      maxShadowOpacity: 0.6,
      mobileScrollSupport: true
    });

    flipbook.loadFromImages(pagesDataUrls);

    // odblokuj przyciski
    prevBtn.disabled = false;
    nextBtn.disabled = false;
    zoomInBtn.disabled = false;
    zoomOutBtn.disabled = false;
    zoomResetBtn.disabled = false;
    toggleLoupeBtn.disabled = false;

    prevBtn.addEventListener('click', prevPage);
    nextBtn.addEventListener('click', nextPage);

    // keyboard
    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'ArrowRight') nextPage();
      if (ev.key === 'ArrowLeft') prevPage();
    });

    // update page info on flip event
    if (typeof flipbook.on === 'function') {
      flipbook.on('flip', (e) => {
        const idx = e.data;
        pageInfo.innerText = `Strona ${idx+1} / ${numPages}`;
      });
    }

    // natychmiast render pierwszych 2 stron w dobrej jakości
    loader.innerText = `Wczytywanie 1 / ${numPages}...`;
    await replacePage(0, currentScale, 'high');

    if (numPages >= 2) {
      loader.innerText = `Wczytywanie 2 / ${numPages}...`;
      await replacePage(1, currentScale, 'high');
    }

    // background render reszty sekwencyjnie (nie obciążaj jednocześnie)
    (async function backgroundRender(){
      for (let i = 3; i <= numPages; i++){
        loader.style.display = 'block';
        loader.innerText = `Wczytywanie ${i} / ${numPages}...`;
        try {
          // render umiarkowanej jakości (baseScale * DPR)
          await replacePage(i - 1, baseScale * DPR, 'high');
        } catch(err) {
          console.error('Błąd renderu strony', i, err);
        }
      }
      loader.style.display = 'none';
      // ustaw informację na aktualnej stronie
      const cur = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
      pageInfo.innerText = `Strona ${cur+1} / ${numPages}`;
    })();

    /* ========== ZOOM (re-render tylko aktualnej strony) ========== */
    zoomInBtn.addEventListener('click', async () => {
      const idx = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
      currentScale = Math.min(currentScale + 0.6, 4 * DPR);
      loader.style.display = 'block';
      loader.innerText = `Powiększanie strony ${idx+1}...`;
      await replacePage(idx, currentScale, 'zoom');
      loader.style.display = 'none';
    });

    zoomOutBtn.addEventListener('click', async () => {
      const idx = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
      currentScale = Math.max(currentScale - 0.6, 0.6 * DPR);
      loader.style.display = 'block';
      loader.innerText = `Pomniejszanie strony ${idx+1}...`;
      await replacePage(idx, currentScale, 'zoom');
      loader.style.display = 'none';
    });

    zoomResetBtn.addEventListener('click', async () => {
      const idx = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
      currentScale = baseScale * DPR;
      loader.style.display = 'block';
      loader.innerText = `Reset jakości strony ${idx+1}...`;
      await replacePage(idx, currentScale, 'high');
      loader.style.display = 'none';
    });

    /* ========== LUPA (overlay) ========== */
    let loupeEnabled = false;
    let loupeImg = null;
    let loupeCache = {}; // loupeCache[idx] = dataURL

    toggleLoupeBtn.addEventListener('click', async () => {
      const idx = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
      loupeEnabled = !loupeEnabled;
      toggleLoupeBtn.style.background = loupeEnabled ? '#d32f2f' : '#388e3c';
      if (!loupeEnabled) { magnifier.style.display = 'none'; return; }

      // przygotuj wysoko-rozdzielczy obraz do lupy
      if (!loupeCache[idx]) {
        loader.style.display = 'block';
        loader.innerText = 'Przygotowywanie lupy...';
        loupeCache[idx] = await renderPageToDataUrl(idx+1, LOUPE_SCALE_MULT * baseScale);
        loader.style.display = 'none';
      }
      loupeImg = new Image();
      loupeImg.src = loupeCache[idx];
      await new Promise(r => loupeImg.onload = r);
      magnifier.style.display = 'block';
    });

    // aktualizuj obraz lupy po zmianie strony
    if (typeof flipbook.on === 'function') {
      flipbook.on('flip', async (e) => {
        const idx = e.data;
        pageInfo.innerText = `Strona ${idx+1} / ${pdfDoc.numPages}`;
        if (!loupeEnabled) return;
        if (!loupeCache[idx]) {
          loader.style.display = 'block';
          loader.innerText = `Przygotowywanie lupy (str ${idx+1})...`;
          loupeCache[idx] = await renderPageToDataUrl(idx+1, LOUPE_SCALE_MULT * baseScale);
          loader.style.display = 'none';
        }
        loupeImg = new Image();
        loupeImg.src = loupeCache[idx];
        await new Promise(r => loupeImg.onload = r);
      });
    }

    container.addEventListener('mousemove', (e) => {
      if (!loupeEnabled || !loupeImg) return;
      const rect = container.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;
      // ustaw magnifier ok. kursora
      const offset = 16;
      magnifier.style.left = (e.clientX + offset) + 'px';
      magnifier.style.top = (e.clientY + offset) + 'px';
      magnifier.style.display = 'block';
      // tworzymy canvas wewnątrz magnifier (jednorazowo)
      if (!magnifier._canvas) {
        const c = document.createElement('canvas');
        c.width = magnifier.clientWidth;
        c.height = magnifier.clientHeight;
        magnifier.innerHTML = '';
        magnifier.appendChild(c);
        magnifier._canvas = c;
        magnifier._ctx = c.getContext('2d', { willReadFrequently: true });
      }
      const ctx = magnifier._ctx;
      const cw = magnifier._canvas.width;
      const ch = magnifier._canvas.height;
      const rectW = rect.width;
      const rectH = rect.height;
      const imgW = loupeImg.width;
      const imgH = loupeImg.height;
      const ratioX = imgW / rectW;
      const ratioY = imgH / rectH;
      const sx = Math.max(0, Math.round(cx * ratioX - cw/2));
      const sy = Math.max(0, Math.round(cy * ratioY - ch/2));
      ctx.clearRect(0,0,cw,ch);
      ctx.drawImage(loupeImg, sx, sy, cw, ch, 0, 0, cw, ch);
    });
    container.addEventListener('mouseleave', () => magnifier.style.display = 'none');

    /* ========== Resize handling (debounced) ========== */
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        // zmiana baseScale dla mobilnych/desktopowych breakpointów
        const oldBase = baseScale;
        baseScale = (window.innerWidth <= 760) ? MOBILE_BASE_SCALE : DESKTOP_BASE_SCALE;
        if (oldBase !== baseScale) {
          // re-render aktualnej strony w nowej jakości
          const idx = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
          replacePage(idx, baseScale * DPR, 'high').catch(()=>{});
        }
        // wymuś przebudowę flipbooka (turnToPage) by wyrównać rozmiar
        try {
          const cur = (typeof flipbook.getCurrentPageIndex === 'function') ? flipbook.getCurrentPageIndex() : 0;
          if (typeof flipbook.turnToPage === 'function') flipbook.turnToPage(cur);
        } catch(e){/*ignore*/}
      }, 220);
    });

  }catch(err){
    console.error('Błąd inicjalizacji flipbooka:', err);
    loader.innerText = 'Błąd ładowania dokumentu';
  }
}

/* start */
window.addEventListener('load', init);
</script>
</body>
</html>
