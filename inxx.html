<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" />
  <title>Katalog produktów — flipbook (wysoka jakość, A4)</title>
  <style>
    :root{--accent:#1976d2;--accent-dark:#1565c0}
    body{font-family:Inter, Arial, Helvetica, sans-serif;margin:0;background:#f5f7fa;color:#111}
    header{padding:16px 12px;text-align:center}
    h1{margin:0;font-size:20px}
    #wrap{max-width:1300px;margin:14px auto;padding:0 12px}
    /* Flipbook container: domyślnie wyglada jak A4 (proporcja 210x297 mm)
       i skaluje się zależnie od ekranu: szerokość = min(95vw, 1100px). */
    #flipbook{
      margin: 12px auto;
      width: min(95vw, 1100px);
      aspect-ratio: 210 / 297;
      height: auto;
      background:#fff;
      border:1px solid #e2e6ea;
      position:relative;
      box-shadow:0 8px 24px rgba(0,0,0,0.06);
      overflow:hidden;
    }
    .loader{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.96);padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-weight:600;z-index:1500}
    .controls{display:flex;gap:10px;justify-content:center;align-items:center;margin:12px 0;z-index:1200;position:relative;flex-wrap:wrap}
    .controls button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 6px 16px rgba(25,118,210,0.12)}
    .controls button.secondary{background:#6b7280}
    .controls button:disabled{opacity:.55;cursor:not-allowed}
    .page-info{font-size:14px;color:#333;margin-left:8px}
    .magnifier{position:fixed;width:220px;height:220px;border-radius:50%;overflow:hidden;border:3px solid rgba(0,0,0,0.12);box-shadow:0 10px 30px rgba(0,0,0,0.12);pointer-events:none;display:none;z-index:9999;background:#fff}
    @media(max-width:760px){
      #flipbook{width:95vw; aspect-ratio:210/297;}
      .magnifier{width:140px;height:140px}
      .controls{gap:6px}
    }
  </style>

  <!-- PDF.js -->
  <script src="pdfjs/pdf.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';</script>

  <!-- StPageFlip -->
  <script src="StPageFlip-2.0.0/page-flip.browser.min.js"></script>
</head>
<body>
  <header><h1>Katalog produktów</h1></header>

  <div id="wrap">
    <div id="flipbook" aria-live="polite"></div>

    <div class="controls" role="toolbar" aria-label="Kontrolki flipbooka">
      <button id="prevBtn" class="secondary" disabled>◀ Poprzednia</button>
      <button id="nextBtn" disabled>Następna ▶</button>

      <!-- usunięte: + / - (zoom) - zgodnie z Twoją prośbą -->

      <button id="toggleLoupeBtn" title="Lupa" disabled style="background:#388e3c">Lupa</button>
      <button id="fullScreenBtn" title="Pełny ekran" disabled style="background:#333">Pełny ekran</button>

      <span class="page-info" id="pageInfo" aria-live="polite">Ładowanie…</span>
      <a id="downloadPdf" href="twoj_plik.pdf" download style="margin-left:12px;color:var(--accent);font-weight:600;text-decoration:none">Pobierz PDF</a>
    </div>

    <div id="magnifier" class="magnifier" aria-hidden="true"></div>
  </div>

<script>
/* ======= Ustawienia jakości i zachowania ======= */
const PDF_URL = "twoj_plik.pdf";
const DPR = Math.max(1, window.devicePixelRatio || 1);

/* QUALITY_MULT - ile razy wyżej niż "fit cover" renderować (większa = lepsza jakość, większe pliki & wolniej)
   Jeżeli chcesz jeszcze wyższą jakość ustaw np. 2.0; domyślnie 1.6 */
const QUALITY_MULT = 1.6;

const LOUPE_SCALE_MULT = Math.max(2, DPR * 2);
/* =============================================== */

pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';

const container = document.getElementById('flipbook');
const loader = document.createElement('div'); loader.className='loader'; loader.innerText='Przygotowywanie...'; container.appendChild(loader);

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const toggleLoupeBtn = document.getElementById('toggleLoupeBtn');
const fullScreenBtn = document.getElementById('fullScreenBtn');
const pageInfo = document.getElementById('pageInfo');
const magnifier = document.getElementById('magnifier');

let pdfDoc = null;
let flipbook = null;
let pagesDataUrls = [];
let pagesCache = {}; // cache stron: pagesCache[idx] = dataUrl
let loupeCache = {}; // wysoka jakość dla lupy

/* helper: tiny placeholder */
function createPlaceholderDataUrl(){
  const c = document.createElement('canvas'); c.width=4; c.height=4;
  const ctx = c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,4,4);
  return c.toDataURL();
}

/* zwraca skalę, która sprawi że strona "cover" wypełni container (dopasowanie) */
async function computeFitScaleForPage(pageNumber, mode='cover'){
  const page = await pdfDoc.getPage(pageNumber);
  const vp = page.getViewport({ scale: 1 });
  const targetW = container.clientWidth * DPR;
  const targetH = container.clientHeight * DPR;
  const scaleX = targetW / vp.width;
  const scaleY = targetH / vp.height;
  return (mode === 'cover') ? Math.max(scaleX, scaleY) : Math.min(scaleX, scaleY);
}

/* render strony do dataURL w zadanym scale (używa willReadFrequently) */
async function renderPageToDataUrl(pageNumber, scale){
  const page = await pdfDoc.getPage(pageNumber);
  const viewport = page.getViewport({ scale: scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  canvas.width = Math.round(viewport.width);
  canvas.height = Math.round(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  return canvas.toDataURL('image/jpeg', 0.92);
}

/* bezpieczne zastosowanie całej tablicy obrazów do flipbooka */
function applyPagesArrayToFlipbook(imagesArray){
  try{
    if (!flipbook) return;
    if (typeof flipbook.updateFromImages === 'function') {
      flipbook.updateFromImages(imagesArray);
      return;
    }
    if (typeof flipbook.loadFromImages === 'function') {
      flipbook.loadFromImages(imagesArray);
      return;
    }
    // DOM fallback
    const imgs = container.querySelectorAll('img');
    for (let i=0;i<imagesArray.length && i<imgs.length;i++) imgs[i].src = imagesArray[i];
  }catch(e){
    console.error('applyPagesArrayToFlipbook error', e);
  }
}

/* replacePage: renderuj i podmieniaj cache + flipbook */
async function replacePage(pageIndexZeroBased, scale){
  const pageNumber = pageIndexZeroBased + 1;
  if (pagesCache[pageIndexZeroBased]) {
    pagesDataUrls[pageIndexZeroBased] = pagesCache[pageIndexZeroBased];
    applyPagesArrayToFlipbook(pagesDataUrls);
    return;
  }
  const dataUrl = await renderPageToDataUrl(pageNumber, scale);
  pagesCache[pageIndexZeroBased] = dataUrl;
  pagesDataUrls[pageIndexZeroBased] = dataUrl;
  applyPagesArrayToFlipbook(pagesDataUrls);
}

/* navigation helper */
function nextPage(){
  if (!flipbook) return;
  if (typeof flipbook.flipNext === 'function') { try { flipbook.flipNext(); return; } catch(e){} }
  if (typeof flipbook.turnToNextPage === 'function') { flipbook.turnToNextPage(); }
}
function prevPage(){
  if (!flipbook) return;
  if (typeof flipbook.flipPrev === 'function') { try { flipbook.flipPrev(); return; } catch(e){} }
  if (typeof flipbook.turnToPrevPage === 'function') { flipbook.turnToPrevPage(); }
}

/* fullscreen toggle */
function toggleFullScreen(){
  if (!document.fullscreenElement) {
    container.requestFullscreen?.() || container.webkitRequestFullscreen?.();
    fullScreenBtn.innerText = 'Wyjdź z pełnego ekranu';
  } else {
    document.exitFullscreen?.();
    fullScreenBtn.innerText = 'Pełny ekran';
  }
}

/* ========== INICJALIZACJA - renderujemy wszystkie strony w wysokiej jakości ========== */
async function init(){
  try{
    const loadingTask = pdfjsLib.getDocument(PDF_URL);
    pdfDoc = await loadingTask.promise;
    const numPages = pdfDoc.numPages;
    pageInfo.innerText = `Strona 0 / ${numPages}`;
    loader.innerText = `Przygotowywanie dokumentu — ${numPages} stron`;

    // placeholdery
    const placeholder = createPlaceholderDataUrl();
    pagesDataUrls = new Array(numPages).fill(placeholder);

    // init flipbook natychmiast (by uniknąć Invalid page number)
    flipbook = new St.PageFlip(container, {
      width: 900, height: 1100,
      size: "stretch", autoSize: true,
      minWidth: 300, maxWidth: 1600, minHeight: 300, maxHeight: 2000,
      showCover: false, usePortrait: true, maxShadowOpacity: 0.6, mobileScrollSupport: true
    });

    flipbook.loadFromImages(pagesDataUrls);

    // odblokuj kontrolki
    prevBtn.disabled = false; nextBtn.disabled = false; toggleLoupeBtn.disabled = false; fullScreenBtn.disabled = false;

    prevBtn.addEventListener('click', prevPage);
    nextBtn.addEventListener('click', nextPage);
    fullScreenBtn.addEventListener('click', toggleFullScreen);

    document.addEventListener('keydown', (ev)=>{ if (ev.key==='ArrowRight') nextPage(); if (ev.key==='ArrowLeft') prevPage(); });

    if (typeof flipbook.on === 'function') {
      flipbook.on('flip', (e) => {
        const idx = e.data;
        pageInfo.innerText = `Strona ${idx+1} / ${numPages}`;
      });
    }

    // RENDER: renderujemy wszystkie strony sekwencyjnie w wysokiej jakości (fit cover * QUALITY_MULT)
    // Uwaga: może być to zasobożerne dla bardzo dużych PDF — jeśli zauważysz problemy, daj znać.
    for (let i = 1; i <= numPages; i++) {
      loader.style.display = 'block';
      loader.innerText = `Renderowanie strony ${i} z ${numPages} (wysoka jakość)...`;
      // compute fit scale and multiply for higher quality
      const fitScale = await computeFitScaleForPage(i, 'cover');
      const hiScale = fitScale * QUALITY_MULT;
      await replacePage(i-1, hiScale);
    }

    loader.style.display = 'none';

    // przygotuj lupę cache pierwszej strony (opcjonalnie - renderuje w wyższej jakości dla lupy)
    // (lupa renderowana na żądanie poniżej)
    toggleLoupeBtn.addEventListener('click', async ()=>{
      const idx = (typeof flipbook.getCurrentPageIndex==='function') ? flipbook.getCurrentPageIndex() : 0;
      if (!loupeCache[idx]) {
        loader.style.display = 'block';
        loader.innerText = 'Przygotowywanie lupy...';
        loupeCache[idx] = await renderPageToDataUrl(idx+1, LOUPE_SCALE_MULT * QUALITY_MULT);
        loader.style.display = 'none';
      }
      // toggle display
      if (magnifier.style.display === 'block') {
        magnifier.style.display = 'none';
        toggleLoupeBtn.style.background = '#388e3c';
      } else {
        toggleLoupeBtn.style.background = '#d32f2f';
        const img = new Image();
        img.src = loupeCache[idx];
        await new Promise(r=>img.onload=r);
        magnifier._img = img;
        magnifier.style.display = 'block';
      }
    });

    // rysowanie lupy (używa magnifier._img)
    container.addEventListener('mousemove', (e)=>{
      if (magnifier.style.display !== 'block' || !magnifier._img) return;
      const rect = container.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;
      const offset = 16;
      magnifier.style.left = (e.clientX + offset) + 'px';
      magnifier.style.top = (e.clientY + offset) + 'px';
      // create canvas inside magnifier once
      if (!magnifier._canvas) {
        const c = document.createElement('canvas'); c.width = magnifier.clientWidth; c.height = magnifier.clientHeight;
        magnifier.innerHTML = ''; magnifier.appendChild(c); magnifier._canvas = c;
        magnifier._ctx = c.getContext('2d', { willReadFrequently: true });
      }
      const ctx = magnifier._ctx; const cw = magnifier._canvas.width; const ch = magnifier._canvas.height;
      const img = magnifier._img;
      const rectW = rect.width; const rectH = rect.height;
      const ratioX = img.width / rectW; const ratioY = img.height / rectH;
      const sx = Math.max(0, Math.round(cx * ratioX - cw/2)); const sy = Math.max(0, Math.round(cy * ratioY - ch/2));
      ctx.clearRect(0,0,cw,ch); ctx.drawImage(img, sx, sy, cw, ch, 0, 0, cw, ch);
    });
    container.addEventListener('mouseleave', ()=>{ magnifier.style.display = 'none'; });

  }catch(err){
    console.error('Błąd inicjalizacji flipbooka:', err);
    loader.innerText = 'Błąd ładowania dokumentu — sprawdź konsolę';
  }
}

/* start */
window.addEventListener('load', init);
</script>
</body>
</html>
