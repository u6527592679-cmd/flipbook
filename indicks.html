<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Katalog produktów</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f5f6f8;color:#111}
  header{padding:12px 14px;text-align:center;background:#fff;border-bottom:1px solid #eceff1}
  h1{margin:0;font-size:20px}
  #wrap{max-width:1400px;margin:8px auto;padding:10px}
  #flipbook{margin:10px auto;width:calc(100% - 40px);max-width:1300px;background:#fff;border:1px solid #e6e9ee;position:relative;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  .loader{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);padding:10px 14px;border-radius:8px;z-index:1500;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-weight:600;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;margin:8px 0}
  button{padding:8px 12px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer}
  button.secondary{background:#6b7280}
  button:disabled{opacity:.55;cursor:not-allowed}
  .page-info{margin-left:8px;color:#333}
  @media (max-width:700px){ #flipbook{width:calc(100% - 24px);} }
  /* Proporcjonalne, nie rozciągane obrazki */
  #flipbook img {
    width: 100%;
    height: auto;
    max-width: 100%;
    object-fit: contain;
    display: block;
    margin: 0 auto;
  }
</style>

<!-- PDF.js -->
<script src="pdfjs/pdf.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';</script>
<!-- StPageFlip -->
<script src="StPageFlip-2.0.0/page-flip.browser.min.js"></script>
</head>
<body>
<header><h1>Katalog produktów</h1></header>

<div id="wrap">
  <div id="flipbook" aria-live="polite"></div>

  <div class="controls" role="toolbar" aria-label="Kontrolki flipbook">
    <button id="prevBtn" class="secondary" disabled>◀ Poprzednia</button>
    <button id="nextBtn" disabled>Następna ▶</button>
    <button id="fullBtn" disabled>Pełny ekran</button>
    <span class="page-info" id="pageInfo">Ładowanie…</span>
    <a href="twoj_plik.pdf" download style="margin-left:12px;color:#1976d2;font-weight:600">Pobierz PDF</a>
  </div>
</div>

<script>
const PDF_URL = 'twoj_plik.pdf';
const DPR = Math.max(1, window.devicePixelRatio || 1);
const MAX_CANVAS_DIM = 14000;

const container = document.getElementById('flipbook');
const loader = document.createElement('div'); loader.className='loader'; loader.innerText='Przygotowywanie...'; container.appendChild(loader);

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const fullBtn = document.getElementById('fullBtn');
const pageInfo = document.getElementById('pageInfo');

let pdfDoc = null;
let flipbook = null;
let pagesData = [];
let pagesCache = {};

function makePlaceholder(){ const c=document.createElement('canvas'); c.width=4; c.height=4; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,4,4); return c.toDataURL(); }

function setContainerHeight(){
  const headerH = document.querySelector('header').offsetHeight || 0;
  const controlsH = document.querySelector('.controls').offsetHeight || 0;
  const margin = 18;
  const available = Math.max(200, window.innerHeight - headerH - controlsH - margin);
  container.style.height = available + 'px';
}

// Render proporcjonalny, wylicza rozmiar canvasu na podstawie kontenera i DPI
async function computeFitScaleAndSize(pageNumber) {
  const page = await pdfDoc.getPage(pageNumber);
  const vp = page.getViewport({ scale: 1 });
  const targetW = container.clientWidth * DPR;
  const targetH = container.clientHeight * DPR;
  const scale = Math.min(targetW / vp.width, targetH / vp.height);
  return {
    scale,
    width: Math.round(vp.width * scale),
    height: Math.round(vp.height * scale)
  };
}

async function renderPageToDataUrl(pageNumber) {
  const { scale, width, height } = await computeFitScaleAndSize(pageNumber);
  const page = await pdfDoc.getPage(pageNumber);
  const viewport = page.getViewport({ scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  canvas.width = width;
  canvas.height = height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  return canvas.toDataURL('image/jpeg', 0.95);
}

function applyImages(images){
  try{
    if(!flipbook) return;
    if(typeof flipbook.updateFromImages==='function'){ flipbook.updateFromImages(images); return; }
    if(typeof flipbook.loadFromImages==='function'){ flipbook.loadFromImages(images); return; }
  }catch(e){ console.error(e); }
}

async function ensurePage(indexZeroBased){
  if(pagesCache[indexZeroBased]){
    pagesData[indexZeroBased] = pagesCache[indexZeroBased];
    applyImages(pagesData);
    return;
  }
  const pageNum = indexZeroBased + 1;
  const dataUrl = await renderPageToDataUrl(pageNum); // już z proporcjami
  pagesCache[indexZeroBased] = dataUrl;
  pagesData[indexZeroBased] = dataUrl;
  applyImages(pagesData);
}

function nextPage(){ if(flipbook){ if(typeof flipbook.flipNext==='function'){ try{ flipbook.flipNext(); return;}catch(e){} } if(typeof flipbook.turnToNextPage==='function') flipbook.turnToNextPage(); }}
function prevPage(){ if(flipbook){ if(typeof flipbook.flipPrev==='function'){ try{ flipbook.flipPrev(); return;}catch(e){} } if(typeof flipbook.turnToPrevPage==='function') flipbook.turnToPrevPage(); }}
function toggleFull() {
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        if (container.requestFullscreen) {
            container.requestFullscreen({ navigationUI: 'hide' }).catch(()=>{});
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen({ navigationUI: 'hide' });
        } else {
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100vw';
            container.style.height = '100vh';
            container.style.zIndex = '9999';
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen().catch(()=>{});
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else {
            container.style.position = '';
            container.style.top = '';
            container.style.left = '';
            container.style.width = '';
            container.style.height = '';
            container.style.zIndex = '';
        }
    }
}

function debounce(fn,wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

async function init(){
  try{
    setContainerHeight();
    const loadingTask = pdfjsLib.getDocument(PDF_URL);
    pdfDoc = await loadingTask.promise;
    const numPages = pdfDoc.numPages;
    pageInfo.innerText = `Strona 0 / ${numPages}`;
    loader.innerText = `Przygotowywanie dokumentu — ${numPages} stron`;

    const placeholder = makePlaceholder();
    pagesData = new Array(numPages).fill(placeholder);

    // Ustaw size: 'stretch', min/maxWidth/Height dla zachowania elastyczności
    flipbook = new St.PageFlip(container,{
      width:900, height:1200, // domyślna proporcja A4
      size:'stretch', autoSize:true,
      minWidth:300, maxWidth:2000, minHeight:300, maxHeight:3000,
      showCover:false, usePortrait:true, maxShadowOpacity:0.6, mobileScrollSupport:true
    });
    flipbook.loadFromImages(pagesData);

    prevBtn.disabled=false; nextBtn.disabled=false; fullBtn.disabled=false;
    prevBtn.onclick = prevPage; nextBtn.onclick = nextPage; fullBtn.onclick = toggleFull;
    document.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight') nextPage(); if(e.key==='ArrowLeft') prevPage(); });

    // render pierwsze 4 strony synchronicznie
    const numInitial = Math.min(4,numPages);
    loader.innerText = `Wczytywanie...`;
    for(let i=0;i<numInitial;i++) await ensurePage(i);

    // w tle reszta
    loader.innerText = 'Wczytywanie pozostałych stron w tle...';
    for(let i=numInitial;i<numPages;i++) ensurePage(i).catch(()=>{});

    loader.style.display='none';
    const cur = (typeof flipbook.getCurrentPageIndex==='function')?flipbook.getCurrentPageIndex():0;
    pageInfo.innerText = `Strona ${cur+1} / ${numPages}`;

    const onResize = debounce(async()=>{
      setContainerHeight();
      const curIdx = (typeof flipbook.getCurrentPageIndex==='function')?flipbook.getCurrentPageIndex():0;
      delete pagesCache[curIdx];
      loader.style.display='block'; loader.innerText='Dopasowywanie do rozmiaru ekranu...';
      await ensurePage(curIdx);
      loader.style.display='none';
      try{ if(typeof flipbook.turnToPage==='function') flipbook.turnToPage(curIdx); }catch(e){}
    },220);
    window.addEventListener('resize',onResize);

  }catch(err){
    console.error('Błąd inicjalizacji:',err);
    loader.innerText='Błąd ładowania dokumentu — sprawdź konsolę';
  }
}
window.addEventListener('load',init);
</script>
</body>
</html>
